name: ğŸš€ iOS E2E Sharded Regression

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ main ]

env:
  PROJECT_NAME: "TestsPOC.xcodeproj"
  SCHEME_NAME: "TestsPOCUITests"
  DIST_JSON_PATH: "scripts/input/account_distribution.json"
  DERIVED_DATA_PATH: "DerivedData"
  TEST_APP_BUNDLE_ID: "rty.TestsPOCUITests"

jobs:
  prepare-shards:
    name: ğŸ§® Prepare Shards
    runs-on: ubuntu-latest
    outputs:
      shard_matrix: ${{ steps.set-matrix.outputs.shards }}
    steps:
      - uses: actions/checkout@v4
      
      - id: set-matrix
        name: ğŸ—ï¸ Extract Shard Keys
        run: |
          SHARDS=$(jq -c 'keys' ${{ env.DIST_JSON_PATH }})
          echo "shards=$SHARDS" >> $GITHUB_OUTPUT

  build-for-testing:
    name: ğŸ—ï¸ Build Binary
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ”¨ Build for Testing
        run: |
          xcodebuild build-for-testing \
            -project "${{ env.PROJECT_NAME }}" \
            -scheme "${{ env.SCHEME_NAME }}" \
            -destination "generic/platform=iOS Simulator" \
            -derivedDataPath "${{ env.DERIVED_DATA_PATH }}"

      - name: ğŸ©¹ Patch .xctestrun
        run: |
          XCTESTRUN_FILE=$(find ${{ env.DERIVED_DATA_PATH }} -name "*.xctestrun" | head -n 1)
          WORK_DIR=$(pwd)
          sed -i '' "s|$WORK_DIR/${{ env.DERIVED_DATA_PATH }}/Build/Products|.|g" "$XCTESTRUN_FILE"

      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-products
          path: ${{ env.DERIVED_DATA_PATH }}/Build/Products
          retention-days: 1

  test-shard:
    name: ğŸ§ª Test Shard [${{ matrix.shard }}]
    needs: [prepare-shards, build-for-testing]
    runs-on: macos-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        shard: ${{ fromJson(needs.prepare-shards.outputs.shard_matrix) }}
    
    steps:
      - name: ğŸ§¹ Pre-Clean Runner
        run: |
          killall Simulator 2> /dev/null || true
          xcrun simctl shutdown all || true
          xcrun simctl delete all || true

      - uses: actions/checkout@v4

      - name: ğŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-products
          path: ${{ env.DERIVED_DATA_PATH }}/Build/Products

      - name: ğŸ“± Select or Create Simulator
        id: select_sim
        run: |
          DEVICE_NAME="E2E-Device-${{ matrix.shard }}"
          TARGET_TYPE="iPhone 16"
          SIM_ID=$(xcrun simctl list devices available -j | jq -r ".devices | map(.[]) | map(select(.name == \"$DEVICE_NAME\")) | .[0].udid")
          
          if [ -z "$SIM_ID" ] || [ "$SIM_ID" == "null" ]; then
              RUNTIME_ID=$(xcrun simctl list runtimes -j | jq -r '.runtimes | map(select(.name | contains("iOS"))) | sort_by(.version) | reverse | .[0].identifier')
              SIM_ID=$(xcrun simctl create "$DEVICE_NAME" "$TARGET_TYPE" "$RUNTIME_ID")
          fi
          echo "sim_id=$SIM_ID" >> $GITHUB_OUTPUT
          
          xcrun simctl boot "$SIM_ID" || true
          
          counter=0
          while [ $counter -lt 60 ]; do
              if xcrun simctl list devices | grep "$SIM_ID" | grep -q "Booted"; then
                  break
              fi
              sleep 2
              counter=$((counter+1))
          done
          xcrun simctl spawn "$SIM_ID" defaults write com.apple.iphonesimulator ConnectHardwareKeyboard -bool false

      - name: ğŸ”¥ Warmup Simulator
        run: |
          SIM_ID="${{ steps.select_sim.outputs.sim_id }}"
          
          APP_PATH=$(find ${{ env.DERIVED_DATA_PATH }}/Build/Products -name "*.app" ! -name "*-Runner.app" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find ${{ env.DERIVED_DATA_PATH }}/Build/Products -name "*.app" | head -n 1)
          fi
          
          echo "ğŸ¯ Warming up: $APP_PATH"
          
          xcrun simctl launch "$SIM_ID" com.apple.mobilesafari
          sleep 5
          xcrun simctl install "$SIM_ID" "$APP_PATH"
          xcrun simctl launch "$SIM_ID" "${{ env.TEST_APP_BUNDLE_ID }}" || true
          sleep 5
          xcrun simctl terminate "$SIM_ID" "${{ env.TEST_APP_BUNDLE_ID }}" || true

      - name: ğŸ Distribute Accounts
        run: |
          chmod +x scripts/distribute_accounts.py
          python3 scripts/distribute_accounts.py --shard "${{ matrix.shard }}"

      - name: âš™ï¸ Parse Tests
        id: parse_tests
        run: |
          TESTS=$(jq -r ".[\"${{ matrix.shard }}\"].tests | join(\" -only-testing:\")" ${{ env.DIST_JSON_PATH }})
          ARGS="-only-testing:$TESTS"
          echo "test_args=$ARGS" >> $GITHUB_OUTPUT

      - name: ğŸƒ Run Tests
        run: |
          XCTESTRUN=$(find ${{ env.DERIVED_DATA_PATH }} -name "*.xctestrun" | head -n 1)
          
          xcodebuild test-without-building \
            -xctestrun "$XCTESTRUN" \
            -destination "platform=iOS Simulator,id=${{ steps.select_sim.outputs.sim_id }}" \
            -resultBundlePath "TestResults-${{ matrix.shard }}.xcresult" \
            -parallel-testing-worker-count 1 \
            -retry-tests-on-failure \
            -test-iterations 3 \
            ${{ steps.parse_tests.outputs.test_args }}

      - name: ğŸ“¦ Stage Result Bundle
        if: always()
        run: |
          mkdir -p UploadStaging
          mv "TestResults-${{ matrix.shard }}.xcresult" UploadStaging/
          
      - name: ğŸ“¤ Upload Result Bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: result-${{ matrix.shard }}
          path: UploadStaging/

  report:
    name: ğŸ“Š Generate HTML Report
    needs: test-shard
    if: always()
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ“¦ Download All Results
        uses: actions/download-artifact@v4
        with:
          pattern: result-*
          merge-multiple: true
          path: all_results

      - name: ğŸº Install Tools
        run: |
          if ! command -v xchtmlreport &> /dev/null; then
              brew install xctesthtmlreport
          fi

      - name: ğŸ“‘ Generate Report
        run: |
          RESULTS=$(find all_results -name "*.xcresult" | tr '\n' ' ')
          
          if [ -z "$RESULTS" ]; then
             echo "âŒ No results found!"
             exit 1
          fi
          
          xchtmlreport -r $RESULTS -o index.html

      - name: ğŸ“¤ Upload HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: HTML-Report
          path: index.html
