name: iOS E2E Sharded Regression

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ main ]

env:
  PROJECT_NAME: "TestsPOC.xcodeproj" 
  SCHEME_NAME: "TestsPOCUITests"
  DIST_JSON_PATH: "scripts/input/account_distribution.json"
  DERIVED_DATA_PATH: "DerivedData"

jobs:
  prepare-shards:
    runs-on: ubuntu-latest
    outputs:
      shard_matrix: ${{ steps.set-matrix.outputs.shards }}
    steps:
      - uses: actions/checkout@v4
      
      - id: set-matrix
        name: Extract Shard Keys
        run: |
          SHARDS=$(jq -c 'keys' ${{ env.DIST_JSON_PATH }})
          echo "shards=$SHARDS" >> $GITHUB_OUTPUT

  build-for-testing:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build for Testing
        run: |
          xcodebuild build-for-testing \
            -project "${{ env.PROJECT_NAME }}" \
            -scheme "${{ env.SCHEME_NAME }}" \
            -destination "generic/platform=iOS Simulator" \
            -derivedDataPath "${{ env.DERIVED_DATA_PATH }}"

      - name: Patch .xctestrun for Relative Paths
        run: |
          XCTESTRUN_FILE=$(find ${{ env.DERIVED_DATA_PATH }} -name "*.xctestrun" | head -n 1)
          WORK_DIR=$(pwd)
          sed -i '' "s|$WORK_DIR/${{ env.DERIVED_DATA_PATH }}/Build/Products|.|g" "$XCTESTRUN_FILE"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-products
          path: ${{ env.DERIVED_DATA_PATH }}/Build/Products
          retention-days: 1

  test-shard:
    needs: [prepare-shards, build-for-testing]
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        shard: ${{ fromJson(needs.prepare-shards.outputs.shard_matrix) }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-products
          path: ${{ env.DERIVED_DATA_PATH }}/Build/Products

      - name: Select or Create Simulator
        id: select_sim
        run: |
          TARGET_DEVICE="iPhone 16"
          
          echo "Looking for existing $TARGET_DEVICE..."
          
          SIM_ID=$(xcrun simctl list devices available -j | jq -r ".devices | map(.[]) | map(select(.name == \"$TARGET_DEVICE\")) | .[0].udid")
          
          if [ -z "$SIM_ID" ] || [ "$SIM_ID" == "null" ]; then
             echo "⚠️ $TARGET_DEVICE not found. Creating a fresh simulator..."
             
             RUNTIME_ID=$(xcrun simctl list runtimes -j | jq -r '.runtimes | map(select(.name | contains("iOS"))) | sort_by(.version) | reverse | .[0].identifier')
             
             if [ -z "$RUNTIME_ID" ]; then
                echo "❌ Error: Could not find any iOS Runtime!"
                exit 1
             fi
             
             echo "✅ Found Runtime: $RUNTIME_ID"
             
             SIM_ID=$(xcrun simctl create "E2E-Shard-Device" "$TARGET_DEVICE" "$RUNTIME_ID")
             echo "✅ Created new simulator: $SIM_ID"
          else
             echo "✅ Found existing simulator: $SIM_ID"
          fi
          
          echo "sim_id=$SIM_ID" >> $GITHUB_OUTPUT
          
          echo "Booting simulator..."
          xcrun simctl boot "$SIM_ID" || true
          
          echo "Waiting for simulator to stabilize..."
          sleep 15

      - name: Distribute Accounts
        run: |
          chmod +x scripts/distribute_accounts.py
          python3 scripts/distribute_accounts.py --shard "${{ matrix.shard }}"

      - name: Parse Tests for Shard
        id: parse_tests
        run: |
          TESTS=$(jq -r ".[\"${{ matrix.shard }}\"].tests | join(\" -only-testing:\")" ${{ env.DIST_JSON_PATH }})
          ARGS="-only-testing:$TESTS"
          echo "test_args=$ARGS" >> $GITHUB_OUTPUT

      - name: Run Tests
        run: |
          XCTESTRUN=$(find ${{ env.DERIVED_DATA_PATH }} -name "*.xctestrun" | head -n 1)
          
          xcodebuild test-without-building \
            -xctestrun "$XCTESTRUN" \
            -destination "platform=iOS Simulator,id=${{ steps.select_sim.outputs.sim_id }}" \
            -resultBundlePath "TestResults-${{ matrix.shard }}.xcresult" \
            -parallel-testing-worker-count 1 \
            ${{ steps.parse_tests.outputs.test_args }}

      - name: Upload Result Bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: result-${{ matrix.shard }}
          path: TestResults-${{ matrix.shard }}.xcresult

  report:
    needs: test-shard
    if: always()
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download All Results
        uses: actions/download-artifact@v4
        with:
          pattern: result-*
          merge-multiple: true
          path: all_results

      - name: Install Tools
        run: |
          brew install xcbeautify
          brew install xctesthtmlreport

      - name: Merge Results & Generate Report
        run: |
          mkdir -p Merged.xcresult
          RESULTS=$(find all_results -name "*.xcresult" | tr '\n' ' ')
          xchtmlreport -r $RESULTS -o index.html

      - name: Upload HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: HTML-Report
          path: index.html
