name: ðŸš€ iOS E2E Sharded Regression

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ main ]

env:
  PROJECT_NAME: "TestsPOC.xcodeproj"
  SCHEME_NAME: "TestsPOCUITests"
  DIST_JSON_PATH: "scripts/input/account_distribution.json"
  DERIVED_DATA_PATH: "DerivedData"
  TEST_APP_BUNDLE_ID: "rty.TestsPOC" 

jobs:

  prepare-shards:
    name: ðŸ§® Prepare Shards
    runs-on: ubuntu-latest
    outputs:
      shard_matrix: ${{ steps.set-matrix.outputs.shards }}
    steps:
      - uses: actions/checkout@v4
      
      - id: set-matrix
        name: ðŸ—ï¸ Extract Shard Keys
        run: |
          SHARDS=$(jq -c 'keys' ${{ env.DIST_JSON_PATH }})
          echo "Found shards: $SHARDS"
          echo "shards=$SHARDS" >> $GITHUB_OUTPUT

  build-for-testing:
    name: ðŸ—ï¸ Build Binary
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ”¨ Build for Testing
        run: |
          xcodebuild build-for-testing \
            -project "${{ env.PROJECT_NAME }}" \
            -scheme "${{ env.SCHEME_NAME }}" \
            -destination "generic/platform=iOS Simulator" \
            -derivedDataPath "${{ env.DERIVED_DATA_PATH }}"

      - name: ðŸ©¹ Patch .xctestrun for Relative Paths
        run: |
          XCTESTRUN_FILE=$(find ${{ env.DERIVED_DATA_PATH }} -name "*.xctestrun" | head -n 1)
          WORK_DIR=$(pwd)
          sed -i '' "s|$WORK_DIR/${{ env.DERIVED_DATA_PATH }}/Build/Products|.|g" "$XCTESTRUN_FILE"

      - name: ðŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-products
          path: ${{ env.DERIVED_DATA_PATH }}/Build/Products
          retention-days: 1

  test-shard:
    name: ðŸ§ª Test Shard [${{ matrix.shard }}]
    needs: [prepare-shards, build-for-testing]
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        shard: ${{ fromJson(needs.prepare-shards.outputs.shard_matrix) }}
    
    steps:
      - name: ðŸ§¹ Pre-Clean Runner
        run: |
          killall Simulator 2> /dev/null || true
          xcrun simctl shutdown all || true
          xcrun simctl delete all || true

      - uses: actions/checkout@v4

      - name: ðŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-products
          path: ${{ env.DERIVED_DATA_PATH }}/Build/Products

      - name: ðŸ“± Select or Create Simulator
        id: select_sim
        run: |
          DEVICE_NAME="E2E-Device-${{ matrix.shard }}"
          TARGET_TYPE="iPhone 16"
          
          echo "ðŸ”§ Managing Simulator: $DEVICE_NAME"
          
          SIM_ID=$(xcrun simctl list devices available -j | jq -r ".devices | map(.[]) | map(select(.name == \"$DEVICE_NAME\")) | .[0].udid")
          
          if [ -z "$SIM_ID" ] || [ "$SIM_ID" == "null" ]; then
              echo "ðŸ†• Creating fresh simulator..."
              RUNTIME_ID=$(xcrun simctl list runtimes -j | jq -r '.runtimes | map(select(.name | contains("iOS"))) | sort_by(.version) | reverse | .[0].identifier')
              SIM_ID=$(xcrun simctl create "$DEVICE_NAME" "$TARGET_TYPE" "$RUNTIME_ID")
              echo "âœ… Created: $SIM_ID"
          else
              echo "â™»ï¸ Found existing: $SIM_ID"
          fi
          
          echo "sim_id=$SIM_ID" >> $GITHUB_OUTPUT
          
          echo "ðŸš€ Booting simulator..."
          xcrun simctl boot "$SIM_ID" || true
          
          echo "â³ Waiting for Boot..."
          counter=0
          while [ $counter -lt 60 ]; do
              if xcrun simctl list devices | grep "$SIM_ID" | grep -q "Booted"; then
                  echo "âœ… Simulator BOOTED!"
                  break
              fi
              sleep 2
              counter=$((counter+1))
          done
          
          xcrun simctl spawn "$SIM_ID" defaults write com.apple.iphonesimulator ConnectHardwareKeyboard -bool false

      - name: ðŸ”¥ Warmup Simulator (Launch Safari & App)
        run: |
          SIM_ID="${{ steps.select_sim.outputs.sim_id }}"
          APP_PATH=$(find ${{ env.DERIVED_DATA_PATH }}/Build/Products -name "*.app" | head -n 1 | xargs basename)
          FULL_APP_PATH="${{ env.DERIVED_DATA_PATH }}/Build/Products/$APP_PATH"
          
          echo "ðŸ‹ï¸â€â™€ï¸ 1. Launching Safari to wake up SpringBoard..."
          xcrun simctl launch "$SIM_ID" com.apple.mobilesafari
          sleep 5
          
          echo "ðŸ“¦ 2. Pre-Installing App ($APP_PATH) to cache signatures..."
          xcrun simctl install "$SIM_ID" "$FULL_APP_PATH"
          
          echo "ðŸš€ 3. Pre-Launching App to break 'First Run' hang..."

          xcrun simctl launch "$SIM_ID" "${{ env.TEST_APP_BUNDLE_ID }}" || true
          sleep 5
          xcrun simctl terminate "$SIM_ID" "${{ env.TEST_APP_BUNDLE_ID }}" || true
          
          echo "âœ… Simulator Primed!"

      - name: ðŸ Distribute Accounts
        run: |
          chmod +x scripts/distribute_accounts.py
          python3 scripts/distribute_accounts.py --shard "${{ matrix.shard }}"

      - name: âš™ï¸ Parse Tests for Shard
        id: parse_tests
        run: |
          TESTS=$(jq -r ".[\"${{ matrix.shard }}\"].tests | join(\" -only-testing:\")" ${{ env.DIST_JSON_PATH }})
          ARGS="-only-testing:$TESTS"
          echo "test_args=$ARGS" >> $GITHUB_OUTPUT

      - name: ðŸƒ Run Tests (Fast Mode)
        run: |
          XCTESTRUN=$(find ${{ env.DERIVED_DATA_PATH }} -name "*.xctestrun" | head -n 1)
          
          xcodebuild test-without-building \
            -xctestrun "$XCTESTRUN" \
            -destination "platform=iOS Simulator,id=${{ steps.select_sim.outputs.sim_id }}" \
            -resultBundlePath "TestResults-${{ matrix.shard }}.xcresult" \
            -parallel-testing-worker-count 1 \
            -retry-tests-on-failure \
            -test-iterations 3 \
            ${{ steps.parse_tests.outputs.test_args }}

      - name: ðŸ“¤ Upload Result Bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: result-${{ matrix.shard }}
          path: TestResults-${{ matrix.shard }}.xcresult

  report:
    name: ðŸ“Š Generate HTML Report
    needs: test-shard
    if: always()
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: ðŸ“¦ Download All Results
        uses: actions/download-artifact@v4
        with:
          pattern: result-*
          path: all_results

      - name: ðŸº Install Tools
        run: |
          if ! command -v xchtmlreport &> /dev/null; then
              brew install xctesthtmlreport
          fi

      - name: ðŸ“‘ Merge Results & Generate
        run: |
          cd all_results
          
          for dir in result-*; do
             [ -d "$dir" ] && mv "$dir" "$dir.xcresult"
          done
          cd ..
          
          RESULTS=$(find all_results -name "*.xcresult" | tr '\n' ' ')
          echo "Merging: $RESULTS"
          
          xchtmlreport -r $RESULTS -o index.html

      - name: ðŸ“¤ Upload HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: HTML-Report
          path: index.html
